node {
  def repourl = "${REGISTRY_URL}/${PROJECT_ID}/${ARTIFACT_REGISTRY}"
  def version = sh(script: "date +%s", returnStdout: true).trim()
  def npmHome = tool name: 'npm', type: 'npm'
  def npmCMD = "${npmHome}/bin/npm"
  def npxCMD = "${npmHome}/bin/npx"
  stage('Checkout'){
    checkout([$class: "GitSCM",
      branches: [[name: '*/main']],
      userRemoteConfigs: [[credentialsId: 'git',
      url: 'https://github.com/IslamHamada/petshop-ui.git']]])
  }
  stage('Build and Push Image'){
    withCredentials([file(credentialsId: 'gcp', variable: 'GC_KEY')]) {
      sh("gcloud auth activate-service-account --key-file=${GC_KEY}")
      sh("gcloud auth configure-docker ${REGISTRY_URL}")
      sh("${npmCMD} install")
      sh("${npxCMD} ng build --configuration production")
      sh("docker build -t ${repourl}/frontend:${version} .")
      sh("docker push ${repourl}/frontend:${version}")
    }
  }
  stage("Deploy"){
    sh("sed -i 's|IMAGE_URL|${repourl}|g' k8s/deployment.yaml")
    sh("sed -i 's|TAG|${version}|g' k8s/deployment.yaml")
    step([$class: 'KubernetesEngineBuilder',
          projectId: env.PROJECT_ID,
          clusterName: env.CLUSTER,
          location: env.ZONE,
          manifestPattern: 'k8s/deployment.yaml',
          credentialsId: env.PROJECT_ID,
          verifyDeployments: true])
  }
}
